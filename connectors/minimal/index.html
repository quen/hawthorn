<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>Hawthorn example page</title>
<script type="text/javascript" src="../../js/hawthorn.js"></script>
<script type="text/javascript">

function init()
{
	var servers=[];
	var preferred=-1;
	for(var i=0;i<3;i++)
	{
		var url=document.getElementById('url'+i).value;
		if(url=='')
		{
			break;
		}

		servers[i]=url;
		if(document.getElementById('preferred'+i).checked)
		{
			preferred=i;
		}		
	}

	hawthorn.init(servers,preferred);
}

function setText(id,message)
{
	var el=document.getElementById(id);
	while(el.firstChild) el.removeChild(el.firstChild);
	el.appendChild(document.createTextNode(message));
}

function setMessages(id,messages)
{
	var el=document.getElementById(id);
	while(el.firstChild) el.removeChild(el.firstChild);
	var intro=document.createElement('p');
	intro.appendChild(document.createTextNode(messages.length+' messages:'));
	el.appendChild(intro);
	var ul=document.createElement('ul');
	el.appendChild(ul);
	for(var i=0;i<messages.length;i++)
	{
		var li=document.createElement('li');
		el.appendChild(li);
		li.appendChild(document.createTextNode(
				new Date(messages[i].time)+' - '+
				messages[i].user+' ('+messages[i].displayname+'): '+
				messages[i].text));
	}
}

function getRecent()
{
	hawthorn.getRecent(
		document.getElementById('channel').value,
		document.getElementById('user').value,
		document.getElementById('displayname').value,
		document.getElementById('keytime').value,
		document.getElementById('key').value,
		60*60*1000,
		10,
		function(messages)
		{
			setMessages('recent',messages);
		},
		function(error)
		{
			setText('recent','ERROR! '+error);
		});
}

function say()
{
	hawthorn.say(
			document.getElementById('channel').value,
			document.getElementById('user').value,
			document.getElementById('displayname').value,
			document.getElementById('keytime').value,
			document.getElementById('key').value,
			document.getElementById('message').value,
			function()
			{
				setText('say','OK, said something!');
			},
			function(error)
			{
				setText('say','ERROR! '+error);
			});			
}

var lastWait=0;

function waitForMessage()
{
	var waitfor=document.getElementById('waitforbutton');
	waitfor.disabled=true;
	setText('waitfor','Waiting for new message...');
	var yes=function(lastTime,messages)
	{
		lastWait=lastTime;
		setMessages("waitfor",messages);				
		waitfor.disabled=false;
	};
	var no=function(error)
	{
		setText('waitfor','ERROR! '+error);
		waitfor.disabled=false;
	};
	if(lastWait==0)
	{
		hawthorn.waitForMessageFirst(
				document.getElementById('channel').value,
				document.getElementById('user').value,
				document.getElementById('displayname').value,
				document.getElementById('keytime').value,
				document.getElementById('key').value,
				60*60*1000,10,yes,no);
	}
	else
	{
		hawthorn.waitForMessage(
				document.getElementById('channel').value,
				document.getElementById('user').value,
				document.getElementById('displayname').value,
				document.getElementById('keytime').value,
				document.getElementById('key').value,
				lastWait,yes,no);
	}
}

function getLog()
{
	hawthorn.getLog(
			document.getElementById('channel').value,
			document.getElementById('keytime').value,
			document.getElementById('key').value,
			document.getElementById('date').value,
			function(lines)
			{
				var logs=document.getElementById('logs');
				while(logs.firstChild) logs.removeChild(logs.firstChild);
				
				var intro=document.createElement('p');
				intro.appendChild(document.createTextNode(lines.length+' lines:'));
				logs.appendChild(intro);

				var pre=document.createElement('pre');
				for(var i=0;i<lines.length;i++)
				{
					pre.appendChild(document.createTextNode(lines[i]));
					pre.appendChild(document.createElement('br'));
				}
				logs.appendChild(pre);
			},
			function(error)
			{
				setText('logs','ERROR! '+error);
			});

}
</script>

</head>
<body>

<h1>Minimal Hawthorn example</h1>

<p>
You can use this page to test a Hawthorn installation without any other 
software. This page also demonstrates how to call the JavaScript functions
when implementing your own connector.
</p>

<p>
To obtain keys that work with your server, use the <tt>&lt;testkey/&gt;</tt> element
in your <tt>configuration.xml</tt>. Keys remain valid for one hour.
</p> 

<p>
Hawthorn's built-in JavaScript library contains additional features not 
demonstrated on this page. This page shows only the basic functions.
</p>


<h2>Init</h2>

<p>
You need to complete this before using any of the other forms.
In a real system, a call to the init function would be automatically generated
by the server-side system.
</p>

<div>
URL <input id="url0" type="text" size="40" /> 
  <input type="radio" id="preferred0" name="preferred" checked="checked" /><br />
URL <input id="url1" type="text" size="40" /> 
  <input type="radio" id="preferred1" name="preferred" /><br />
URL <input id="url2" type="text" size="40" /> 
  <input type="radio" id="preferred2" name="preferred" /><br />
<input type="radio" name="preferred" /> No preference
</div>

<div><input type="button" value="Init connection" onclick="init()"/></div>



<h2>Authorisation details</h2>

<p>
In a real system, these details would be defined as hidden fields or JavaScript
variables by the server-side system, which knows the magic number and is 
able to generate keys itself.
</p>

<div>
Channel <input id="channel" type="text" size="20" /><br />
User ID <input id="user" type="text" size="20" /><br />
Display name <input id="displayname" type="text" size="20" /><br />
Key time <input id="keytime" type="text" size="20" /><br />
Key <input id="key" type="text" size="40"/>
</div>

<h2>Recent messages</h2>

<h3>Message list</h3>
<div id="recent">Not yet obtained</div>

<div><input type="button" value="Get recent messages" onclick="getRecent()"/></div>

<h2>Say</h2>
<div id="say">Not said anything yet</div>
<div>
Message <input id="message" type="text" size="40" />
<div><input type="button" value="Say" onclick="say()"/></div>
</div>

<h2>Wait for message</h2>

<h3>Message list</h3>
<div id="waitfor">Not yet requested</div>

<div><input type="button" id="waitforbutton" value="Wait for next message" onclick="waitForMessage()"/></div>

<h2>Get logs</h2>

<p>
In order to get logs, you need to have the username <strong>_admin</strong> 
and display name <strong>_</strong>. Note that you can also request for the
special reserved channel name !system to get the system log.
</p>

<h3>Logs</h3>
<div id="logs">Not yet requested</div>

<div>
Date <input id="date" type="text" size="20" /><br />
<input type="button" value="Get logs" onclick="getLog()"/></div>

</body>
</html>